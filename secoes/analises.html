<div class="destaque-wrapper">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <div id="notificacao-novo-artigo">
    <i class="fa-solid fa-satellite-dish"></i>
    <div>
      <div style="font-size: 10px; font-weight: 800; opacity: 0.8; text-transform: uppercase;">Atualiza칞칚o via Cloud</div>
      <div id="novo-artigo-titulo" style="font-size: 13px; font-weight: 700;">Conectando ao AniGeek...</div>
    </div>
  </div>

  <div id="container-principal"></div>
  
  <div id="pagination-control" style="text-align: center; padding: 30px; display: none;">
      <button id="btn-carregar-mais" class="btn-paginacao-geek">
          <i class="fa-solid fa-chevron-down"></i> Carregar mais conte칰dos
      </button>
  </div>

  <div id="notificacao-video">
    <div style="flex: 1;">
      <div style="font-size: 10px; font-weight: 800; opacity: 0.6; text-transform: uppercase;">Deseja assistir?</div>
      <div id="notif-titulo" style="font-size: 13px; font-weight: 700;">T칤tulo</div>
    </div>
    <button class="btn-confirmar-video" id="btn-confirmar">Confirmar</button>
    <i class="fa-solid fa-xmark" style="cursor:pointer; padding: 5px;" onclick="window.fecharNotif()"></i>
  </div>

  <div id="toast-copiado">Link copiado!</div>

  <div id="modal-noticia">
    <div id="modal-conteudo">
      <button id="modal-fechar" onclick="window.fecharModal()">칑</button>
      <div id="modal-header-layout">
         <div id="modal-titulo" class="destaque-titulo" style="margin-top: 0;"></div>
         <div id="modal-categoria" class="destaque-categoria"></div>
      </div>
      <p id="modal-resumo" class="destaque-resumo"></p>
      <a id="modal-link" class="btn-ver-artigo"><i class="fa-solid fa-book-open"></i> Ler artigo completo</a>
      <div id="modal-ficha" class="destaque-info-grid"></div>
      <iframe id="modal-video" allowfullscreen></iframe>
    </div>
  </div>

  <div id="modal-comentarios-geek" class="modal-geek-overlay">
    <div class="modal-geek-content">
      <div class="modal-geek-header">
        <div class="header-main-title">
          <i class="fa-solid fa-comments"></i>
          <span>Comunidade <small id="contador-comentarios">0 coment치rios</small></span>
        </div>
        <button onclick="window.fecharComentarios()" class="btn-geek-close">칑</button>
      </div>
      
      <div class="modal-geek-body" id="flow-comentarios">
        </div>

      <div class="modal-geek-footer">
        <div class="input-wrapper-geek">
          <div id="meu-avatar-display" class="mini-my-avatar" style="background: #333;">?</div>
          <input type="text" placeholder="Adicione um coment치rio..." id="input-comentario-real">
          <button class="btn-send-geek" id="btn-enviar-comentario">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      onSnapshot, 
      addDoc, 
      query, 
      where, 
      orderBy, 
      serverTimestamp,
      collectionGroup 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBC_ad4X9OwCHKvcG_pNQkKEl76Zw2tu6o",
      authDomain: "anigeeknews.firebaseapp.com",
      projectId: "anigeeknews",
      storageBucket: "anigeeknews.firebasestorage.app",
      messagingSenderId: "769322939926",
      appId: "1:769322939926:web:6eb91a96a3f74670882737",
      measurementId: "G-G5T8CCRGZT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Vari치veis de Estado
    let todasAsNoticias = [];
    let noticiasExibidas = 5;
    let playerAlvo = '';
    let urlAlvo = '';
    let usuarioAtual = null;
    let unsubscribeComentarios = null;
    let noticiaAbertaId = null;

    // --- L칍GICA DE IDENTIFICA칂츾O DO USU츼RIO ---
    function obterIdentidadeUsuario() {
      if (auth.currentUser) {
        return {
          id: auth.currentUser.uid,
          nome: auth.currentUser.displayName || "Usu치rio Geek",
          foto: auth.currentUser.photoURL || null,
          tipo: 'logado'
        };
      } else {
        let idAnonimo = localStorage.getItem('geek_anon_id');
        if (!idAnonimo) {
          idAnonimo = 'user-' + Math.floor(Math.random() * 9000 + 1000);
          localStorage.setItem('geek_anon_id', idAnonimo);
        }
        return {
          id: idAnonimo,
          nome: idAnonimo,
          foto: null,
          tipo: 'anonimo'
        };
      }
    }

    onAuthStateChanged(auth, (user) => {
      usuarioAtual = obterIdentidadeUsuario();
      const avatarDiv = document.getElementById('meu-avatar-display');
      if(avatarDiv) {
        avatarDiv.innerText = usuarioAtual.nome.charAt(0).toUpperCase();
        avatarDiv.title = usuarioAtual.nome;
      }
    });

    // --- FUN칂칏ES UTILIT츼RIAS ---
    function limparEspacos(url) { return url ? url.trim() : url; }

    window.shareNews = (titulo, url) => {
      if (navigator.share) {
        navigator.share({ title: titulo, url }).catch(console.error);
      } else {
        window.copiarLink(url);
      }
    };

    window.copiarLink = async (url) => {
      try {
        await navigator.clipboard.writeText(url);
        const toast = document.getElementById('toast-copiado');
        toast.classList.add('mostrar');
        setTimeout(() => toast.classList.remove('mostrar'), 2500);
      } catch (err) { console.error("Erro copiar:", err); }
    };

    // --- MODAL DE COMENT츼RIOS (L칍GICA FIREBASE) ---
    window.abrirComentarios = (idNoticia) => {
      noticiaAbertaId = idNoticia;
      document.getElementById('modal-comentarios-geek').classList.add('active');
      document.body.style.overflow = 'hidden';
      carregarComentarios(idNoticia);
    };

    window.fecharComentarios = () => {
      if (unsubscribeComentarios) unsubscribeComentarios();
      document.getElementById('modal-comentarios-geek').classList.remove('active');
      document.body.style.overflow = 'auto';
      noticiaAbertaId = null;
    };

    async function carregarComentarios(idNoticia) {
      const container = document.getElementById('flow-comentarios');
      container.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.6;">Carregando conversas...</div>';

      // Usamos collectionGroup para buscar em todos os documentos de usu치rios
      const q = query(
        collectionGroup(db, "comentarios"),
        where("noticiaId", "==", idNoticia),
        orderBy("timestamp", "desc")
      );

      unsubscribeComentarios = onSnapshot(q, (snapshot) => {
        document.getElementById('contador-comentarios').innerText = `${snapshot.size} coment치rios`;
        
        if (snapshot.empty) {
          container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">Seja o primeiro a comentar! 游</div>';
          return;
        }

        container.innerHTML = snapshot.docs.map(doc => {
          const c = doc.data();
          const dataFormatada = c.timestamp ? new Date(c.timestamp.seconds * 1000).toLocaleDateString() : 'Agora';
          const corAvatar = c.userTipo === 'anonimo' ? '#777' : '#e63946';
          
          return `
            <div class="geek-comment-card">
              <div class="geek-avatar" style="background: ${corAvatar};">${c.userName.charAt(0).toUpperCase()}</div>
              <div class="geek-info-col">
                <div class="geek-user-row">
                    <span class="g-name">${c.userName}</span>
                    ${c.userTipo === 'logado' ? '<span class="g-badge badge-pro">GEEK</span>' : ''}
                    <span class="g-time">${dataFormatada}</span>
                </div>
                <div class="geek-text">${c.texto}</div>
                <div class="geek-actions-row">
                    <span><i class="fa-regular fa-heart"></i> Curtir</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }, (error) => {
        console.error("Erro ao carregar coment치rios:", error);
        container.innerHTML = '<div style="color:red; text-align:center;">Erro ao carregar coment치rios.</div>';
      });
    }

    async function enviarComentario() {
      const input = document.getElementById('input-comentario-real');
      const texto = input.value.trim();

      if (!texto || !noticiaAbertaId) return;

      const user = obterIdentidadeUsuario();
      
      try {
        // Caminho: usuarios -> {userID} -> comentarios -> {doc}
        const caminhoRef = collection(db, "usuarios", user.id, "comentarios");
        
        await addDoc(caminhoRef, {
          noticiaId: noticiaAbertaId,
          texto: texto,
          userName: user.nome,
          userTipo: user.tipo,
          timestamp: serverTimestamp()
        });

        input.value = "";
      } catch (e) {
        alert("Erro ao enviar: " + e.message);
      }
    }

    document.getElementById('btn-enviar-comentario').onclick = enviarComentario;
    document.getElementById('input-comentario-real').onkeypress = (e) => {
      if(e.key === 'Enter') enviarComentario();
    };

    // --- L칍GICA DE V칈DEO E MODAL DE NOT칈CIA ---
    window.pedirTroca = (idPlayer, idVideo, titulo, cor) => {
      playerAlvo = idPlayer;
      urlAlvo = `https://www.youtube.com/embed/${idVideo}?autoplay=1`;
      const notif = document.getElementById('notificacao-video');
      document.getElementById('notif-titulo').innerText = titulo;
      notif.style.setProperty('--notif-cor', cor);
      notif.classList.add('visivel');
    };

    window.fecharNotif = () => document.getElementById('notificacao-video').classList.remove('visivel');

    document.getElementById('btn-confirmar').onclick = () => {
      const player = document.getElementById(playerAlvo);
      if (player) player.src = urlAlvo;
      window.fecharNotif();
    };

    window.fecharModal = () => {
      document.getElementById('modal-noticia').style.display = 'none';
      document.getElementById('modal-video').src = "";
      const url = new URL(window.location);
      url.searchParams.delete('id');
      window.history.pushState({}, '', url);
    };

    function renderizarNoticias() {
      const container = document.getElementById('container-principal');
      const btnPaginacao = document.getElementById('pagination-control');
      if (!container) return;

      const baseUrl = window.location.origin + window.location.pathname;
      const listaParaExibir = todasAsNoticias.slice(0, noticiasExibidas);

      container.innerHTML = listaParaExibir.map(news => {
        const shareUrl = `${baseUrl}?id=${encodeURIComponent(news.id)}`;
        const viewCount = news.views || (Math.floor(Math.random() * 900) + 100 + "K");

        return `
        <article class="destaque-secao" id="artigo-${news.id}" style="--tema-cor: ${news.cor}">
          <div class="destaque-padding">
            <div class="destaque-categoria"><i class="fa-solid fa-hashtag"></i> ${news.categoria}</div>
            <div class="destaque-header">
              <h2 class="destaque-titulo">${news.titulo}</h2>
              <div class="menu-opcoes-container" tabindex="0">
                <button class="btn-tres-pontos"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                <div class="dropdown-conteudo header-dropdown">
                  <a href="#" onclick="event.preventDefault(); window.copiarLink('${shareUrl}');"><i class="fa-regular fa-copy"></i> Copiar Link</a>
                </div>
              </div>
            </div>
            <p class="destaque-resumo">${news.resumo}</p>
            <a href="${news.linkArtigo}" target="_blank" class="btn-ver-artigo"><i class="fa-solid fa-book-open"></i> Ver artigo completo</a>
            <div class="destaque-info-grid">
              ${news.ficha ? news.ficha.map(item => `<div class="info-item"><span class="info-label">${item.label}</span><span class="info-valor">${item.valor}</span></div>`).join('') : ''}
            </div>
          </div>
          <div class="destaque-media">
            <iframe id="player-${news.id}" src="${limparEspacos(news.videoPrincipal)}" allowfullscreen></iframe>
          </div>
          <div class="premium-actions-bar">
              <button class="btn-premium-icon" onclick="window.shareNews('${news.titulo.replace(/'/g, "\\'")}', '${shareUrl}')">
                <i class="fa-solid fa-share-nodes"></i> Compartilhar
              </button>
              <button class="btn-premium-icon btn-stats">
                <i class="fa-solid fa-chart-column"></i> <span class="stats-num">${viewCount}</span>
              </button>
          </div>
          <div class="comments-trigger-bar" onclick="window.abrirComentarios('${news.id}')">
            <div class="trigger-left">
                <div class="avatars-stack"><div class="av-s" style="background:#555"></div><div class="av-s" style="background:#e63946"></div></div>
                <span>Ver discuss칚o da comunidade...</span>
            </div>
            <i class="fa-solid fa-chevron-right" style="opacity: 0.5;"></i>
          </div>
        </article>`;
      }).join('');

      btnPaginacao.style.display = noticiasExibidas < todasAsNoticias.length ? 'block' : 'none';
    }

    document.getElementById('btn-carregar-mais').onclick = () => {
        noticiasExibidas += 5;
        renderizarNoticias();
    };

    function carregarTudoRealTime() {
      onSnapshot(collection(db, "analises"), (snapshot) => {
        todasAsNoticias = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        todasAsNoticias.sort((a, b) => (b.data || 0) - (a.data || 0));
        if(todasAsNoticias.length > 0) document.getElementById('novo-artigo-titulo').innerText = todasAsNoticias[0].titulo;
        renderizarNoticias();
      });
    }

    carregarTudoRealTime();
  </script>

  <style>
    /* Estilos preservados e otimizados */
    #modal-noticia { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 99999; padding: 20px; overflow-y: auto; }
    #modal-conteudo { background: white; color: #121212; max-width: 900px; margin: 40px auto; padding: 30px; border-radius: 8px; position: relative; }
    #modal-fechar { position: absolute; top: 15px; right: 15px; background: #eee; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; }
    #modal-video { width: 100%; aspect-ratio: 16/9; border: none; }
    .premium-actions-bar { display: flex; padding: 12px 15px; gap: 10px; border-top: 1px solid #f0f0f0; background: #fff; }
    .btn-premium-icon { background: #f8f9fa; border: none; padding: 8px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .comments-trigger-bar { margin: 10px 15px 25px 15px; background: #f1f3f5; border-radius: 12px; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .avatars-stack { display: flex; }
    .av-s { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #f1f3f5; margin-left: -8px; }
    .modal-geek-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 9999; display: none; justify-content: center; align-items: flex-end; }
    .modal-geek-overlay.active { display: flex; }
    .modal-geek-content { background: #fff; width: 100%; max-width: 600px; height: 85vh; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-geek-body { flex: 1; overflow-y: auto; padding: 20px; }
    .geek-comment-card { display: flex; gap: 12px; margin-bottom: 20px; }
    .geek-avatar { width: 36px; height: 36px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
    .g-name { font-weight: 700; font-size: 13px; }
    .g-time { font-size: 11px; color: #999; margin-left: 5px; }
    .g-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: #000; color: #fff; margin-left: 5px; }
    .input-wrapper-geek { display: flex; align-items: center; background: #f0f2f5; padding: 8px 15px; border-radius: 25px; gap: 10px; width: 100%; }
    .input-wrapper-geek input { flex: 1; background: transparent; border: none; outline: none; }
    .btn-send-geek { background: none; border: none; color: #e63946; cursor: pointer; font-size: 18px; }
    #toast-copiado { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; display: none; z-index: 100000; }
    #toast-copiado.mostrar { display: block; }
  </style>
</div>
