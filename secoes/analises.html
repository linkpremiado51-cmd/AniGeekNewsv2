<body>
<div class="destaque-wrapper">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <div id="notificacao-novo-artigo">
    <i class="fa-solid fa-satellite-dish"></i>
    <div>
      <div style="font-size: 7px; font-weight: 800; opacity: 0.8; text-transform: uppercase;">Atualização via Cloud</div>
      <div id="novo-artigo-titulo" style="font-size: 9.1px; font-weight: 700;">Conectando ao AniGeek...</div>
    </div>
  </div>

  <div id="hero-area"></div>

  <div id="container-principal"></div>
  
  <div id="pagination-control" style="text-align: center; padding: 21px; display: none;">
      <button id="btn-carregar-mais" class="btn-paginacao-geek">
          <i class="fa-solid fa-chevron-down"></i> Carregar mais conteúdos
      </button>
  </div>

  <div id="notificacao-video">
    <div style="flex: 1;">
      <div style="font-size: 7px; font-weight: 800; opacity: 0.6; text-transform: uppercase;">Deseja assistir?</div>
      <div id="notif-titulo" style="font-size: 9.1px; font-weight: 700;">Título</div>
    </div>
    <button class="btn-confirmar-video" id="btn-confirmar">Confirmar</button>
    <i class="fa-solid fa-xmark" style="cursor:pointer; padding: 3.5px;" onclick="window.fecharNotif()"></i>
  </div>

  <div id="toast-copiado">Link copiado!</div>

  <div id="modal-noticia">
    <div id="modal-conteudo">
      <button id="modal-fechar" onclick="window.fecharModal()">×</button>
      <div id="modal-header-layout">
         <div id="modal-titulo" class="destaque-titulo" style="margin-top: 0;"></div>
         <div id="modal-categoria" class="destaque-categoria"></div>
      </div>
      <p id="modal-resumo" class="destaque-resumo"></p>
      <a id="modal-link" class="btn-ver-artigo"><i class="fa-solid fa-book-open"></i> Ler artigo completo</a>
      <div id="modal-ficha" class="destaque-info-grid"></div>
      <iframe id="modal-video" allowfullscreen></iframe>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBC_ad4X9OwCHKvcG_pNQkKEl76Zw2tu6o",
      authDomain: "anigeeknews.firebaseapp.com",
      projectId: "anigeeknews",
      storageBucket: "anigeeknews.firebasestorage.app",
      messagingSenderId: "769322939926",
      appId: "1:769322939926:web:6eb91a96a3f74670882737",
      measurementId: "G-G5T8CCRGZT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let todasAsNoticias = [];
    let noticiasExibidas = 5;
    let playerAlvo = '';
    let urlAlvo = '';

    function limparEspacos(url) {
      return url ? url.trim() : url;
    }

    // --- LOGICA DE SEGUIR CATEGORIA ---
    window.seguirCategoria = async (idDocumento) => {
        try {
            const docRef = doc(db, "analises", idDocumento);
            await updateDoc(docRef, { seguidores: increment(1) });
            
            // Feedback visual simples
            const btn = document.querySelector('.btn-seguir');
            if(btn) {
                btn.innerHTML = '<i class="fa-solid fa-check"></i> SEGUINDO';
                btn.style.background = "#28a745";
            }
        } catch (err) { console.error("Erro ao seguir:", err); }
    };

    window.shareNews = (titulo, url) => {
      if (navigator.share) {
        navigator.share({ title: titulo, url }).catch(console.error);
      } else {
        window.copiarLink(url);
      }
    };

    window.copiarLink = async (url) => {
      try {
        await navigator.clipboard.writeText(url);
        const toast = document.getElementById('toast-copiado');
        toast.classList.add('mostrar');
        setTimeout(() => toast.classList.remove('mostrar'), 2500);
      } catch (err) { console.error("Erro copiar:", err); }
    };

    window.pedirTroca = (idPlayer, idVideo, titulo, cor) => {
      playerAlvo = idPlayer;
      urlAlvo = `https://www.youtube.com/embed/${idVideo}?autoplay=1`;
      const notif = document.getElementById('notificacao-video');
      document.getElementById('notif-titulo').innerText = titulo;
      notif.style.setProperty('--notif-cor', cor);
      notif.classList.add('visivel');
    };

    window.fecharNotif = () => {
      document.getElementById('notificacao-video').classList.remove('visivel');
    };

    const btnConfirmar = document.getElementById('btn-confirmar');
    if(btnConfirmar) {
        btnConfirmar.onclick = () => {
          const player = document.getElementById(playerAlvo);
          if (player) player.src = urlAlvo;
          window.fecharNotif();
        };
    }

    window.fecharModal = () => {
      document.getElementById('modal-noticia').style.display = 'none';
      document.getElementById('modal-video').src = ""; 
      const url = new URL(window.location);
      url.searchParams.delete('id');
      window.history.pushState({}, '', url);
    };

    async function incrementarVisualizacao(idNoticia) {
      try {
        const noticiaRef = doc(db, "analises", idNoticia);
        await updateDoc(noticiaRef, { visualizacoes: increment(1) });
      } catch(err) {
        console.error("Erro ao incrementar visualizações:", err);
      }
    }

    function abrirNoticiaEmModal(noticia) {
      document.getElementById('modal-titulo').innerText = noticia.titulo;
      document.getElementById('modal-categoria').innerHTML = `<i class="fa-solid fa-video"></i> ${noticia.categoria}`;
      document.getElementById('modal-resumo').innerText = noticia.resumo;
      document.getElementById('modal-link').href = noticia.linkArtigo;

      let fichaHtml = "";
      if (noticia.ficha) {
          fichaHtml = noticia.ficha.map(item =>
            `<div class="info-item"><span class="info-label">${item.label}</span><span class="info-valor">${item.valor}</span></div>`
          ).join('');
      }
      document.getElementById('modal-ficha').innerHTML = fichaHtml;

      if (noticia.fichaCategoria) {
        const modalFichaCat = `
        <div class="ficha-categoria" style="border-left: 4px solid ${noticia.fichaCategoria.cor};">
            <img src="${limparEspacos(noticia.fichaCategoria.perfilImg)}" alt="Imagem do editor">
            <div class="ficha-info">
                ${noticia.fichaCategoria.info.map(item => `
                    <div class="info-item">
                        <span class="info-label">${item.label}:</span>
                        <span class="info-valor">${item.valor}</span>
                    </div>
                `).join('')}
            </div>
        </div>`;
        document.getElementById('modal-ficha').insertAdjacentHTML('beforebegin', modalFichaCat);
      }

      document.getElementById('modal-video').src = limparEspacos(noticia.videoPrincipal);
      document.getElementById('modal-noticia').style.display = 'block';

      setTimeout(() => incrementarVisualizacao(noticia.id), 50);
    }

    window.curtirNoticia = async (idNoticia) => {
      try {
        const spanCurtidas = document.querySelector(`#btn-curtir-${idNoticia} .num-like`);
        if(spanCurtidas) {
           let atual = parseInt(spanCurtidas.innerText) || 0;
           spanCurtidas.innerText = atual + 1;
        }

        const noticiaRef = doc(db, "analises", idNoticia);
        await updateDoc(noticiaRef, { curtidas: increment(1) });
      } catch(err) {
        console.error("Erro ao curtir:", err);
      }
    };

    function verificarNoticiaNaUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id');
      if (id && todasAsNoticias.length > 0) {
        const noticia = todasAsNoticias.find(n => n.id === id);
        if (noticia) {
          abrirNoticiaEmModal(noticia);
        }
      }
    }

    async function injetarComentariosDinamicos() {
      const containers = document.querySelectorAll('.container-comentarios-dinamico');
      if (containers.length === 0) return;
      try {
        await import('./comentarios/comentarios.js');
      } catch (err) { console.error("Erro scripts comentarios", err); }
    }

    // NOVA FUNÇÃO: Renderiza a Capa Hero Premium
    function renderizarHero(noticiaBase) {
        const heroArea = document.getElementById('hero-area');
        if (!heroArea || !noticiaBase || !noticiaBase.capaUrl) {
            if(heroArea) heroArea.style.display = 'none';
            return;
        }

        heroArea.innerHTML = `
            <div class="hero-premium-box" style="--hero-accent: ${noticiaBase.cor || '#4361ee'}">
                <img src="${limparEspacos(noticiaBase.capaUrl)}" class="hero-main-img">
                <div class="hero-premium-overlay">
                    <div class="hero-content-info">
                        <h1 class="hero-cat-title">${noticiaBase.categoria}</h1>
                        <p class="hero-cat-summary">${noticiaBase.capaDesc || ''}</p>
                        
                        <div class="hero-premium-actions">
                            <button class="btn-seguir" onclick="window.seguirCategoria('${noticiaBase.id}')">
                                <i class="fa-solid fa-plus"></i> SEGUIR
                            </button>
                            <div class="hero-stat-badge">
                                <i class="fa-solid fa-users"></i>
                                <span><b>${noticiaBase.seguidores || 0}</b> Seguidores</span>
                            </div>
                            <button class="btn-hero-circle-share" onclick="window.shareNews('${noticiaBase.categoria}', window.location.href)">
                                <i class="fa-solid fa-share-nodes"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        heroArea.style.display = 'block';
    }

    function renderizarNoticias() {
      const container = document.getElementById('container-principal');
      const btnPaginacao = document.getElementById('pagination-control');
      if (!container) return;

      const baseUrl = window.location.origin + window.location.pathname;
      
      // A primeira notícia define o Hero da página
      if (todasAsNoticias.length > 0) {
          renderizarHero(todasAsNoticias[0]);
      }

      const listaParaExibir = todasAsNoticias.slice(0, noticiasExibidas);

      listaParaExibir.forEach(news => {
        const artigoExistente = document.getElementById(`artigo-${news.id}`);
        const shareUrl = `${baseUrl}?id=${encodeURIComponent(news.id)}`;

        if (artigoExistente) {
            const spanLike = artigoExistente.querySelector('.num-like');
            if(spanLike) spanLike.innerText = news.curtidas || 0;
            const spanView = artigoExistente.querySelector('.num-view');
            if(spanView) spanView.innerText = news.visualizacoes || 0;
            // Atualizar seguidores no Hero caso o ID coincida
            const heroSeguidores = document.querySelector('.hero-stat-badge b');
            if(heroSeguidores && news.id === todasAsNoticias[0].id) {
                heroSeguidores.innerText = news.seguidores || 0;
            }
        } else {
            let fichaCategoriaHtml = '';
            if (news.fichaCategoria) {
                fichaCategoriaHtml = `
                <div class="ficha-categoria" style="border-left: 4px solid ${news.fichaCategoria.cor};">
                    <img src="${limparEspacos(news.fichaCategoria.perfilImg)}" alt="Imagem do editor">
                    <div class="ficha-info">
                        ${news.fichaCategoria.info.map(item => `
                            <div class="info-item">
                                <span class="info-label">${item.label}:</span>
                                <span class="info-valor">${item.valor}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }

            const html = `
            <article class="destaque-secao" id="artigo-${news.id}" style="--tema-cor: ${news.cor}">
              <div class="destaque-padding">
                <div class="destaque-categoria"><i class="fa-solid fa-hashtag"></i> ${news.categoria}</div>
                
                <div class="destaque-header">
                  <h2 class="destaque-titulo">${news.titulo}</h2>
                  <div class="menu-opcoes-container" tabindex="0">
                    <button class="btn-tres-pontos"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                    <div class="dropdown-conteudo header-dropdown">
                      <a href="#"><i class="fa-regular fa-bookmark"></i> Salvar</a>
                      <a href="#" onclick="event.preventDefault(); window.copiarLink('${shareUrl}');"><i class="fa-regular fa-copy"></i> Copiar Link</a>
                    </div>
                  </div>
                </div>

                ${fichaCategoriaHtml}

                <p class="destaque-resumo">${news.resumo}</p>
                <a href="${news.linkArtigo}" class="btn-ver-artigo"><i class="fa-solid fa-book-open"></i> Ver artigo completo</a>
                
                <div class="destaque-info-grid">
                  ${news.ficha ? news.ficha.map(item => `<div class="info-item"><span class="info-label">${item.label}</span><span class="info-valor">${item.valor}</span></div>`).join('') : ''}
                </div>
              </div>
              
              <div class="destaque-media">
                <iframe id="player-${news.id}" src="${limparEspacos(news.videoPrincipal)}" allowfullscreen></iframe>
              </div>
              
              <div class="premium-actions-bar">
                  <button class="btn-premium-icon" id="btn-curtir-${news.id}" onclick="curtirNoticia('${news.id}')">
                    <i class="fa-regular fa-thumbs-up"></i> Útil (<span class="num-like">${news.curtidas || 0}</span>)
                  </button>
                  <button class="btn-premium-icon" onclick="event.preventDefault(); window.shareNews('${news.titulo.replace(/'/g, "\\'")}', '${shareUrl}')">
                    <i class="fa-solid fa-share-nodes"></i> Compartilhar
                  </button>
                  <button class="btn-premium-icon btn-stats">
                    <i class="fa-solid fa-chart-column"></i>
                    <span class="stats-num num-view">${news.visualizacoes || 0}</span>
                  </button>
                  <button class="btn-premium-icon btn-monetize">
                    <i class="fa-regular fa-gem"></i>
                  </button>
              </div>

              <div class="carrossel-temas">
                <div class="carrossel-header"><span class="temas-label">Vídeos Relacionados</span></div>
                <div class="temas-scroll-wrapper"><div class="temas-container">
                    ${news.relacionados ? news.relacionados.map(rel => `
                      <div class="tema-card" onclick="window.pedirTroca('player-${news.id}', '${rel.idVid}', '${rel.titulo.replace(/'/g, "\\'")}', '${news.cor}')">
                        <img src="${limparEspacos(rel.thumb)}" class="tema-thumb">
                        <div class="tema-titulo">${rel.titulo}</div>
                      </div>`).join('') : ''}
                </div></div>
              </div>

              <div class="secao-produtos-banner">
                <div class="banner-header"><i class="fa-solid fa-cart-shopping"></i> Produtos Recomendados</div>
                <div class="banner-lista">
                    ${news.produtos ? news.produtos.map(prod => `
                      <a href="${limparEspacos(prod.link)}" target="_blank" class="banner-produto-item">
                        <div class="banner-img-box">
                          <img src="${limparEspacos(prod.img)}" class="banner-thumb">
                        </div>
                        <div class="banner-info">
                          <div class="banner-titulo">${prod.nome}</div>
                          <div class="banner-desc">${prod.desc || 'Item selecionado especialmente para você pela nossa equipe Geek.'}</div>
                          <div class="banner-link-fake">Ver na loja <i class="fa-solid fa-chevron-right"></i></div>
                        </div>
                      </a>`).join('') : ''}
                </div>
              </div>

              <div class="container-comentarios-dinamico" data-noticia-id="${news.id}"></div>
            </article>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }
      });

      injetarComentariosDinamicos();

      if (noticiasExibidas < todasAsNoticias.length) {
          btnPaginacao.style.display = 'block';
      } else {
          btnPaginacao.style.display = 'none';
      }
    }

    document.getElementById('btn-carregar-mais').onclick = () => {
        noticiasExibidas += 5;
        renderizarNoticias();
    };

    function carregarTudoRealTime() {
      const q = collection(db, "analises");
      onSnapshot(q, (snapshot) => {
        const noticiasFB = [];
        snapshot.forEach((doc) => {
          const d = doc.data();
          noticiasFB.push({ id: doc.id, ...d });
        });
        
        todasAsNoticias = [...noticiasFB];
        todasAsNoticias.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        if(todasAsNoticias.length > 0) {
            document.getElementById('novo-artigo-titulo').innerText = todasAsNoticias[0].titulo;
        }

        renderizarNoticias();
        verificarNoticiaNaUrl();
      });
    }

    carregarTudoRealTime();
  </script>

  <style>
    /* DESIGN PREMIUM HERO */
    .hero-premium-box {
        position: relative;
        width: 100%;
        min-height: 250px;
        background: #000;
        margin-bottom: 20px;
        overflow: hidden;
        display: flex;
        align-items: flex-end;
    }
    .hero-main-img {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        object-fit: cover;
        opacity: 0.7;
    }
    .hero-premium-overlay {
        position: relative;
        z-index: 2;
        width: 100%;
        padding: 40px 20px 25px 20px;
        background: linear-gradient(to top, rgba(0,0,0,0.9) 30%, transparent);
    }
    .hero-cat-title {
        color: white;
        font-size: 26px;
        font-weight: 900;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: -1px;
    }
    .hero-cat-summary {
        color: rgba(255,255,255,0.8);
        font-size: 11px;
        margin: 5px 0 15px 0;
        max-width: 80%;
        line-height: 1.4;
    }
    .hero-premium-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .btn-seguir {
        background: var(--hero-accent);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 800;
        font-size: 10px;
        cursor: pointer;
        transition: 0.3s;
    }
    .hero-stat-badge {
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(5px);
        color: white;
        padding: 7px 12px;
        border-radius: 6px;
        font-size: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .btn-hero-circle-share {
        width: 32px; height: 32px;
        border-radius: 50%;
        background: white;
        color: #000;
        border: none;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
    }

    /* Estilos originais preservados e ajustados */
    .btn-stats .stats-num { 
        font-size: 9.8px; 
        font-weight: 800; 
        opacity: 1; 
        color: #333;
    }

    #modal-noticia {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.9);
      z-index: 99999;
      padding: 14px;
      overflow-y: auto;
    }
    #modal-conteudo {
      background: white;
      color: #121212;
      max-width: 630px;
      margin: 28px auto;
      padding: 21px;
      border-radius: 5.6px;
      position: relative;
    }
    #modal-fechar {
      position: absolute; top: 10.5px; right: 10.5px;
      background: #eee; border: none; width: 22.4px; height: 22.4px;
      border-radius: 50%; font-size: 12.6px; cursor: pointer;
    }
    #modal-video { width: 100%; aspect-ratio: 16 / 9; margin: 14px 0; border: none; }

    /* ... (restante do CSS inalterado conforme o original fornecido) ... */

    .premium-actions-bar {
        display: flex;
        align-items: center;
        padding: 8.4px 10.5px;
        gap: 7px;
        border-top: 1px solid #f0f0f0;
        background: #fff;
        overflow-x: auto;
    }

    .btn-premium-icon {
        background: #f8f9fa;
        border: 1px solid transparent;
        padding: 5.6px 9.8px;
        border-radius: 14px;
        font-size: 8.4px;
        font-weight: 700;
        color: #444;
        display: flex;
        align-items: center;
        gap: 5.6px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }
    .btn-premium-icon:hover { background: #e9ecef; border-color: #dee2e6; }
    
    .btn-stats { background: transparent; border: 1px solid #eee; cursor: default; }
    .btn-monetize { color: #d4af37; background: #fffcf0; border: 1px solid #fae19d; }

    .btn-paginacao-geek {
        background: #212529; color: white; border: none;
        padding: 8.4px 21px; border-radius: 21px;
        font-weight: bold; cursor: pointer; font-size: 9.1px;
        text-transform: uppercase; letter-spacing: 0.35px;
        box-shadow: 0 2.8px 7px rgba(0,0,0,0.2);
    }

    .container-comentarios-dinamico {
        margin: 7px 10.5px 17.5px 10.5px;
    }

    .ficha-categoria {
        background: #fff9f0;
        border-radius: 6px;
        margin: 6px 0;
        padding: 7px 10px;
        display: flex;
        align-items: center;
        gap: 7px;
        font-size: 9px;
        border-left: 4px solid;
    }

    .ficha-categoria img {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        object-fit: cover;
    }

    .ficha-categoria .ficha-info {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        max-width: 100%;
        overflow-x: auto;
        padding-bottom: 2px;
    }

    .ficha-categoria .info-item {
        display: flex;
        align-items: baseline;
        gap: 3px;
        white-space: nowrap;
    }

    .ficha-categoria .info-label { font-weight: 600; }

    .secao-produtos-banner {
        margin: 14px 10.5px;
        padding: 12px;
        background: #fff;
        border: 1px solid #f0f0f0;
        border-radius: 12px;
    }
    .banner-header {
        font-size: 10px;
        font-weight: 800;
        color: #999;
        text-transform: uppercase;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .banner-lista { display: flex; flex-direction: column; gap: 10px; }
    
    .banner-produto-item {
        display: flex;
        text-decoration: none;
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    .banner-produto-item:hover {
        transform: translateY(-2px);
        background: #fff;
        border-color: var(--tema-cor);
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .banner-img-box {
        width: 95px;
        min-width: 95px;
        height: 95px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
    }
    .banner-thumb {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    
    .banner-info {
        padding: 10px 14px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex: 1;
    }
    .banner-titulo {
        font-size: 11.5px;
        font-weight: 800;
        color: #1a1a1a;
        margin-bottom: 3px;
        line-height: 1.2;
    }
    .banner-desc {
        font-size: 9px;
        color: #777;
        margin-bottom: 8px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .banner-link-fake {
        font-size: 9px;
        font-weight: 700;
        color: var(--tema-cor);
        display: flex;
        align-items: center;
        gap: 4px;
        text-transform: uppercase;
    }

    .carrossel-temas { margin: 10.5px; }
    .carrossel-header { margin-bottom: 7px; }
    .temas-label { font-size: 9.1px; font-weight: 800; text-transform: uppercase; opacity: 0.5; }
    .temas-container { display: flex; gap: 10.5px; overflow-x: auto; scrollbar-width: none; }
    .tema-card { min-width: 105px; cursor: pointer; }
    .tema-thumb { width: 105px; height: 59.5px; border-radius: 5.6px; object-fit: cover; }
    .tema-titulo { font-size: 8.4px; font-weight: 700; margin-top: 3.5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</div>
</body>
