<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<div class="destaque-wrapper">
  <div id="notificacao-novo-artigo">
    <i class="fa-solid fa-satellite-dish"></i>
    <div>
      <div style="font-size: 7px; font-weight: 800; opacity: 0.8; text-transform: uppercase;">Atualiza√ß√£o via Cloud</div>
      <div id="novo-artigo-titulo-local" style="font-size: 9.1px; font-weight: 700;">Conectando ao AniGeek...</div>
    </div>
  </div>

  <div id="hero-area-local"></div>
  <div id="feed-noticias-local"></div>
  
  <div id="pagination-control-local" style="text-align: center; padding: 21px; display: none;">
      <button id="btn-carregar-mais-local" class="btn-paginacao-geek">
          <i class="fa-solid fa-chevron-down"></i> Carregar mais conte√∫dos
      </button>
  </div>
</div>

<script type="module">
    // Importa√ß√µes necess√°rias com verifica√ß√£o de inst√¢ncia (getApps)
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    console.log("üì° [ABA-MANCHETES] Script interno iniciado.");

    const firebaseConfig = {
      apiKey: "AIzaSyBC_ad4X9OwCHKvcG_pNQkKEl76Zw2tu6o",
      authDomain: "anigeeknews.firebaseapp.com",
      projectId: "anigeeknews",
      storageBucket: "anigeeknews.firebasestorage.app",
      messagingSenderId: "769322939926",
      appId: "1:769322939926:web:6eb91a96a3f74670882737"
    };

    // L√≥gica para evitar o erro "duplicate-app"
    const app = !getApps().length ? initializeApp(firebaseConfig) : getApps()[0];
    const db = getFirestore(app);

    let todasAsNoticias = [];
    let noticiasExibidas = 5;

    function renderizarNoticiasLocal() {
        console.log("üé® [ABA-MANCHETES] Renderizando lista de not√≠cias.");
        const container = document.getElementById('feed-noticias-local');
        if (!container) return;
        
        container.innerHTML = ""; 

        const listaParaExibir = todasAsNoticias.slice(0, noticiasExibidas);
        
        listaParaExibir.forEach(news => {
            const html = `
                <article class="destaque-secao" style="--tema-cor: ${news.cor || '#e50914'}; margin-bottom: 20px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: var(--card-bg);">
                    <img src="${news.capaNoticia || news.capaUrl}" style="width: 100%; aspect-ratio: 16/9; object-fit: cover;" onerror="this.src='https://placehold.co/600x400?text=Erro+Capa'">
                    <div style="padding: 15px;">
                        <div class="destaque-categoria" style="color: ${news.cor || 'red'}">${news.categoria || 'Novidade'}</div>
                        <h2 style="font-size: 18px; margin: 10px 0;">${news.titulo}</h2>
                        <p style="font-size: 13px; opacity: 0.8;">${news.resumo || ''}</p>
                    </div>
                </article>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });

        const btnPaginacao = document.getElementById('pagination-control-local');
        if(btnPaginacao) btnPaginacao.style.display = noticiasExibidas < todasAsNoticias.length ? 'block' : 'none';
    }

    // Radar de escuta espec√≠fico desta aba
    console.log("üõ∞Ô∏è [ABA-MANCHETES] Conectando radar Firestore...");
    onSnapshot(collection(db, "analises"), (snapshot) => {
        todasAsNoticias = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Ordena√ß√£o por timestamp (garantindo que n√£o quebre se for nulo)
        todasAsNoticias.sort((a, b) => {
            const timeA = a.timestamp?.seconds || 0;
            const timeB = b.timestamp?.seconds || 0;
            return timeB - timeA;
        });
        
        const label = document.getElementById('novo-artigo-titulo-local');
        if(label && todasAsNoticias.length > 0) label.innerText = todasAsNoticias[0].titulo;
        
        renderizarNoticiasLocal();
    }, (error) => {
        console.error("‚ùå [ABA-MANCHETES] Falha no onSnapshot:", error);
    });

    const btnMais = document.getElementById('btn-carregar-mais-local');
    if (btnMais) {
        btnMais.onclick = () => {
            console.log("‚ûï [ABA-MANCHETES] Carregando mais itens...");
            noticiasExibidas += 5;
            renderizarNoticiasLocal();
        };
    }
</script>
