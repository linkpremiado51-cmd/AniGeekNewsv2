<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta name="ppck-ver" content="68939c8da52b56e7fdbd2814436b04db" />
    <meta name="6a97888e-site-verification" content="ccb57535b53ed6b31254339d34d7ea73">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>AniGeekNews | Jornalismo Geek</title>
    <meta name="description" content="Jornalismo independente sobre cultura pop, animes, games e cinema.">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <link rel="stylesheet" href="estilos/geral.css">
    <link rel="stylesheet" href="estilos/cabecalho-rodape.css">
    <link rel="stylesheet" href="estilos/componentes.css">

    <style>
        html { scroll-behavior: smooth; }
        #progress-bar {
            position: fixed; top: 0; left: 0; height: 3px;
            background: var(--primary-color, #e50914);
            width: 0%; z-index: 9999; transition: width 0.3s ease;
        }
        .top-banner-ad {
            width: 100%; display: flex; justify-content: center; align-items: center;
            background: var(--bg-body); padding: 8px 0; border-bottom: 1px solid var(--border-ui); z-index: 9998;
        }
        #conteudo_de_destaque {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .destaque-secao.destacado {
            animation: destacarArtigo 1.5s ease-in-out; position: relative;
        }
        @keyframes destacarArtigo {
            0% { box-shadow: 0 0 0 0 rgba(229, 9, 20, 0); }
            25% { box-shadow: 0 0 0 8px rgba(229, 9, 20, 0.15); }
            100% { box-shadow: 0 0 0 0 rgba(229, 9, 20, 0); }
        }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .switch-container {
            display: flex; align-items: center; background: rgba(0,0,0,0.05);
            padding: 4px 8px; border-radius: 20px;
        }
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 18px;
        }
        .slider:before {
            position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-color, #e50914); }
        input:checked + .slider:before { transform: translateX(16px); }
        .theme-icon { font-size: 12px; margin-right: 5px; color: var(--text-muted); }
    </style>
</head>

<body>

<script>
    (function() {
        try {
            const saved = localStorage.getItem('anigeek_persistence_v2');
            if (saved) {
                const state = JSON.parse(saved);
                if (state.scrollY > 0) window.scrollTo(0, state.scrollY);
            }
        } catch (e) {}
    })();
</script>

<div id="progress-bar"></div>
<div class="top-banner-ad"></div>

<div class="sticky-header-group">
    <header>
        <div class="nav-container">
            <a href="./index.html" class="logo">Anime I Geek</a>
            <ul class="nav-menu">
                <li class="nav-item"><a href="#">Animes</a></li>
                <li class="nav-item"><a href="#">Games</a></li>
                <li class="nav-item"><a href="#">Mangás</a></li>
                <li class="nav-item" id="area-usuario"><span>Aguardando...</span></li>
            </ul>
            <div class="header-actions">
                <div class="switch-container">
                    <i class="fas fa-moon theme-icon"></i>
                    <label class="switch">
                        <input type="checkbox" id="mobileThemeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <button class="menu-toggle" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>
    <div class="filter-scroller" id="filterScroller"></div>
</div>

<main id="dynamic-content">
    <section class="hero">
        <div id="conteudo_de_destaque">
            <p style="text-align:center;padding-top:100px;color:var(--text-muted)">Sincronizando portal...</p>
        </div>
    </section>
</main>

<div class="mobile-menu" id="mobileMenu">
    <button class="close-menu" onclick="toggleMobileMenu()">×</button>
    <div id="container-menu-perfil"></div>
    <div class="mobile-menu-item"><a href="./index.html">Início</a></div>
    <div class="mobile-menu-item"><a href="#">Animes</a></div>
    <div class="mobile-menu-item"><a href="#">Games</a></div>
    <div class="mobile-menu-item"><a href="#">Mangás</a></div>
</div>

<script type="module" src="scripts/config-firebase.js"></script>
<script type="module" src="scripts/tema.js"></script>
<script type="module" src="scripts/navegacao.js"></script>
<script src="scripts/recomendacao-secao.js"></script>

<script>
function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    if(menu) menu.classList.toggle('active');
}

(function() {
    const PERSISTENCE_KEYS = {
        STATE: 'anigeek_persistence_v2',
        SESSION_TS: 'anigeek_session_ts_v2'
    };
    
    function saveState() {
        try {
            const activeTab = document.querySelector('#filterScroller .filter-tag.active');
            const state = {
                scrollY: window.scrollY,
                activeTabId: activeTab ? (activeTab.dataset.section || activeTab.dataset.id) : 'manchetes',
                newsLoaded: window.noticiasExibidas || 5,
                lastArticleId: window.lastArticleId || null,
                timestamp: Date.now()
            };
            localStorage.setItem(PERSISTENCE_KEYS.STATE, JSON.stringify(state));
            localStorage.setItem(PERSISTENCE_KEYS.SESSION_TS, Date.now().toString());
        } catch (e) {}
    }

    function loadState() {
        try {
            const saved = localStorage.getItem(PERSISTENCE_KEYS.STATE);
            if (!saved) return null;
            const state = JSON.parse(saved);
            const ts = parseInt(localStorage.getItem(PERSISTENCE_KEYS.SESSION_TS) || '0');
            if (Date.now() - ts > 45 * 60 * 1000) return null;
            return state;
        } catch (e) { return null; }
    }

    function restoreState() {
        const state = loadState();
        
        // --- LÓGICA DE FORÇAR CLIQUE PARA USUÁRIO NOVO ---
        if (!state) {
            console.log("Usuário novo: Forçando clique na primeira aba disponível.");
            const forceFirstTab = setInterval(() => {
                const firstTab = document.querySelector('#filterScroller .filter-tag');
                if (firstTab) {
                    clearInterval(forceFirstTab);
                    firstTab.click();
                }
            }, 200);
            setTimeout(() => clearInterval(forceFirstTab), 4000); // Para de tentar após 4s
            return;
        }

        if (state.newsLoaded) window.noticiasExibidas = state.newsLoaded;

        if (state.activeTabId) {
            const checkTab = setInterval(() => {
                const tab = document.querySelector(`.filter-tag[data-section="${state.activeTabId}"], .filter-tag[data-id="${state.activeTabId}"]`);
                if (tab) {
                    clearInterval(checkTab);
                    if (!tab.classList.contains('active')) tab.click();
                }
            }, 100);
            setTimeout(() => {
                clearInterval(checkTab);
                // Se não achou a aba salva, clica na primeira pra não ficar escuro
                if(!document.querySelector('.filter-tag.active')) {
                    const fallback = document.querySelector('#filterScroller .filter-tag');
                    if(fallback) fallback.click();
                }
            }, 3000);
        }

        const perseguirArtigo = (attempts = 0) => {
            const article = state.lastArticleId ? document.getElementById(`artigo-${state.lastArticleId}`) : null;
            const btnMais = document.getElementById('btn-carregar-mais');
            if (article) {
                article.scrollIntoView({ behavior: 'instant', block: 'center' });
                article.classList.add('destacado');
            } else if (btnMais && btnMais.offsetParent !== null && attempts < 10) {
                btnMais.click();
                setTimeout(() => perseguirArtigo(attempts + 1), 600);
            }
        };
        setTimeout(perseguirArtigo, 1500);
    }

    document.addEventListener('DOMContentLoaded', () => {
        restoreState();
        setInterval(saveState, 5000);
        window.addEventListener('scroll', () => {
            clearTimeout(window.scTimer);
            window.scTimer = setTimeout(saveState, 500);
        });
    });

    window.saveStateGlobal = saveState;
})();

window.addEventListener('load', () => {
    let lastScroll = 0;
    window.addEventListener('scroll', () => {
        const scrollTop = window.scrollY;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = (scrollTop / (docHeight || 1)) * 100;
        const pb = document.getElementById('progress-bar');
        if(pb) pb.style.width = `${scrollPercent}%`;
    });
});
</script>
</body>
</html>
